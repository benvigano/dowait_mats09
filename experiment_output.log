nohup: ignoring input
WARNING:root:With reduced precision, it is advised to use `from_pretrained_no_processing` instead of `from_pretrained`.
WARNING:root:You are not using LayerNorm, so the writing weights can't be centered! Skipping
[2025-09-13 01:43:32 CEST] SQLite cache initialized. Found 1390 cached generations for models: test-model, nebius-qwen-test, deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B, nebius-Qwen/Qwen3-4B-fast, nebius-Qwen/Qwen3-14B
[2025-09-13 01:43:53 CEST] Core module loaded successfully. All functionality imported from specialized modules.
[2025-09-13 01:43:53 CEST] ‚ö†Ô∏è Note: Configuration constants moved to notebook.py for better modularity.
[2025-09-13 01:43:53 CEST] Core module loaded successfully. All functionality imported from specialized modules.
[2025-09-13 01:43:53 CEST] ‚ö†Ô∏è Note: Configuration constants moved to notebook.py for better modularity.
[2025-09-13 01:43:53 CEST] Environment variables loaded. Script starting.
[2025-09-13 01:43:53 CEST] Results will be saved to: results/experiment_2025-09-13_01-43-53_CEST
[2025-09-13 01:43:53 CEST] 
[2025-09-13 01:43:53 CEST] ============================================================
[2025-09-13 01:43:53 CEST] üé≤ SELECTING DIVERSE PROBLEMS
[2025-09-13 01:43:53 CEST] ============================================================
[2025-09-13 01:43:53 CEST] üìä Selecting 500 diverse problems from MATH dataset (seed=42)
[2025-09-13 01:43:53 CEST]   Loading prealgebra...
[2025-09-13 01:43:54 CEST]     Selected 68 problems from prealgebra
[2025-09-13 01:43:54 CEST]   Loading algebra...
[2025-09-13 01:43:55 CEST]     Selected 68 problems from algebra
[2025-09-13 01:43:55 CEST]   Loading geometry...
[2025-09-13 01:43:55 CEST]     Selected 68 problems from geometry
[2025-09-13 01:43:55 CEST]   Loading number_theory...
[2025-09-13 01:43:56 CEST]     Selected 68 problems from number_theory
[2025-09-13 01:43:56 CEST]   Loading counting_and_probability...
[2025-09-13 01:43:56 CEST]     Selected 68 problems from counting_and_probability
[2025-09-13 01:43:56 CEST]   Loading intermediate_algebra...
[2025-09-13 01:43:57 CEST]     Selected 68 problems from intermediate_algebra
[2025-09-13 01:43:57 CEST]   Loading precalculus...
[2025-09-13 01:43:58 CEST]     Selected 68 problems from precalculus
[2025-09-13 01:43:58 CEST] ‚úÖ Final selection: 476 problems
[2025-09-13 01:43:58 CEST]   Level distribution: {'Level 5': 161, 'Level 2': 63, 'Level 3': 98, 'Level 4': 126, 'Level 1': 28}
[2025-09-13 01:43:58 CEST]   Subject distribution: {'algebra': 68, 'counting_and_probability': 68, 'geometry': 68, 'intermediate_algebra': 68, 'precalculus': 68, 'number_theory': 68, 'prealgebra': 68}
[2025-09-13 01:43:58 CEST] üìä Selected 476 problems for experiment
[2025-09-13 01:43:59 CEST] Loading HuggingFace model 'deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B'...
[2025-09-13 01:44:01 CEST] HuggingFace model loaded successfully.
[2025-09-13 01:44:01 CEST] Model device: cuda:0
[2025-09-13 01:44:01 CEST] ‚úÖ Huggingface model loaded
[2025-09-13 01:44:01 CEST] 
[2025-09-13 01:44:01 CEST] ============================================================
[2025-09-13 01:44:01 CEST] üéØ STARTING BASELINE EXPERIMENT
[2025-09-13 01:44:01 CEST] ============================================================
[2025-09-13 01:44:01 CEST] Checking cache for baseline results...
[2025-09-13 01:44:10 CEST] Baseline: Found 476/476 cached results.
[2025-09-13 01:44:10 CEST] Saving baseline results to SQLite database...
[2025-09-13 01:44:17 CEST] Baseline complete. Smart Accuracy: 57.77%. Generation errors: 0. Avg steps: 170.3
[2025-09-13 01:44:17 CEST] Smart evaluation breakdown: {'correct': np.int64(275), 'incorrect': np.int64(168), 'failure': np.int64(33)}
[2025-09-13 01:44:17 CEST] Evaluation methods: {'simple_match': np.int64(193), 'anthropic_incorrect': np.int64(168), 'anthropic_correct': np.int64(82), 'anthropic_failure': np.int64(33)}

--- Baseline Results Summary ---
Total results: 476
Correct: 275
Incorrect: 201
Usable mistakes: 168
Sample answers:
  Problem 0: generated_answer='7', correct=False
  Problem 1: generated_answer='105', correct=True
  Problem 2: generated_answer='3335', correct=False
--------------------------------

[2025-09-13 01:44:17 CEST] ‚úÖ Baseline experiment completed: 476 problems processed
üìä Database Summary:
   Total problems: 476
   Baseline completed: 476 (275 correct)
[2025-09-13 01:44:17 CEST] 
[2025-09-13 01:44:17 CEST] ============================================================
[2025-09-13 01:44:17 CEST] üíâ STARTING INTERVENTION TESTING
[2025-09-13 01:44:17 CEST] ============================================================
[2025-09-13 01:44:17 CEST] Starting intervention testing...
[2025-09-13 01:44:17 CEST] Found 168 problems with usable error locations for intervention testing.
[2025-09-13 01:44:17 CEST] Checking cache for intervention results...
[2025-09-13 01:44:23 CEST] Intervention Test: Found 336 cached results. Processing 0 new generations.
[2025-09-13 01:44:23 CEST] Saving intervention results to SQLite database...
[2025-09-13 01:44:28 CEST] Intervention testing complete: 168 problems with analyzable mistakes tested
[2025-09-13 01:44:28 CEST] Intervention testing complete. Correction rates:
condition
Corrective_Original   27.38%
Corrective_Strong     28.57%

--- Intervention Results Summary ---
Total interventions: 336
Corrected: 94
Sample intervention answers:
  Problem 0: intervened_answer='8', corrected=True
  Problem 0: intervened_answer='7', corrected=False
  Problem 2: intervened_answer='10001', corrected=False
-------------------------------------

[2025-09-13 01:44:28 CEST] ‚úÖ Intervention testing completed: 336 interventions tested
üìä Database Summary:
   Total problems: 476
   Baseline completed: 476 (275 correct)
   Interventions completed: 168 (48 corrected)
[2025-09-13 01:44:28 CEST] 
[2025-09-13 01:44:28 CEST] ============================================================
[2025-09-13 01:44:28 CEST] üîÑ SWITCHING TO TRANSFORMERLENS FOR ACTIVATION PATCHING
[2025-09-13 01:44:28 CEST] ============================================================
[2025-09-13 01:44:28 CEST] üóëÔ∏è Dropping model from memory to prevent OOM...
[2025-09-13 01:44:30 CEST] ‚úÖ Model dropped from memory
[2025-09-13 01:44:30 CEST] Loading TransformerLens model 'deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B'...
[2025-09-13 01:44:30 CEST] Using device: cuda
Loaded pretrained model deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B into HookedTransformer
[2025-09-13 01:44:40 CEST] TransformerLens model loaded successfully.
[2025-09-13 01:44:40 CEST] Model device: cuda:0
[2025-09-13 01:44:40 CEST] ‚úÖ TransformerLens model loaded for activation patching

--- Activation Patching Candidate Selection ---
1. Found 94 successful interventions.
Sample successful intervention answers:
  Problem 0: intervened_answer = '8'
  Problem 14: intervened_answer = '\dfrac{175}{2}'
  Problem 18: intervened_answer = 'None'

2. Found 69 corresponding baseline runs.
Sample baseline answers:
  Problem 0: generated_answer = '7'
  Problem 14: generated_answer = 'None'
  Problem 18: generated_answer = 'None'

3. Merged DF has 94 rows before filtering.
Key columns for filtering:
  Problem 0: intervened_answer='8', generated_answer='7'
  Problem 14: intervened_answer='\dfrac{175}{2}', generated_answer='None'
  Problem 18: intervened_answer='None', generated_answer='None'
Full columns list: ['problem_id', 'problem_intervention', 'ground_truth_answer_intervention', 'condition', 'intervened_cot', 'intervened_answer', 'is_corrected', 'error_intervention', 'mistake_sentence', 'truncation_point', 'intervention_phrase', 'original_cot_length', 'truncated_cot_length', 'final_prompt', 'problem_baseline', 'raw_prompt', 'ground_truth_full', 'ground_truth_answer_baseline', 'full_generated_solution', 'generated_answer', 'is_correct', 'smart_evaluation', 'evaluation_method', 'error_line_number', 'error_line_content', 'mistake_sentence_usable', 'error_baseline']

4. After filtering: 48 candidates remain.
Sample filtered candidates:
  Problem 0: source='8', dest='7'
  Problem 24: source='\dfrac{1}{83}', dest='\dfrac{7}{581}'
[2025-09-13 01:44:40 CEST] Found 48 robust candidates for patching after filtering.
[2025-09-13 01:44:40 CEST] Found a perfect candidate for patching: For how many real values of $x$ is $\sqrt{63-\sqrt{x}}$ an integer?...
Traceback (most recent call last):
  File "/workspace/mats_09_neel_nanda_submission/notebook.py", line 240, in <module>
    source_prompt = truncated_cot + intervention_phrases[best_corrective_condition]
                                                         ^^^^^^^^^^^^^^^^^^^^^^^^^
NameError: name 'best_corrective_condition' is not defined
